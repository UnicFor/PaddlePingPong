import{M as b}from"./MarkdownRenderer-Fb-eApji.js";import{j as f,c as i,o as d,a as s,w as c,C as m,F as u,r as h,t as g,D as v,E as M,h as w,n as k,b as R,v as S,G as x,u as E}from"./index-BHrTllVn.js";import{u as _}from"./Main-BC5xypv6.js";import{_ as A}from"./Logo-CmG9raUI.js";import"./index-BtuGy7By.js";const T={components:{MarkdownRenderer:b},data(){return{messages:[],inputMessage:"",report:"",selectedApi:"qianfan",selectedModel:"ernie-x1",selectedMode:"custom",graphRagEnabled:!0,apiModels:{openai:[{value:"gpt-4o",text:"GPT-4o"},{value:"gpt-3.5-turbo",text:"GPT-3.5"}],qianfan:[{value:"ernie-x1",text:"ERNIE X1"},{value:"ernie-4.5",text:"ERNIE 4.5"},{value:"deepseek-r1",text:"DeepSeek R1"},{value:"deepseek-v3",text:"DeepSeek V3"}]},modes:[{value:"custom",label:"自定义"},{value:"expert",label:"专家"}]}},created(){this.authStore=E(),this.historyStore=_()},computed:{currentVideoId(){const o=this.historyStore.historyItems.find(e=>e.id===this.historyStore.currentAnalysisId);return(o==null?void 0:o.video_id)||null}},watch:{selectedApi(o){this.selectedModel=this.apiModels[o][0].value}},methods:{async sendMessage(){const o=this.inputMessage.trim().replace(/\n/g,`

`);if(o){this.messages.push({role:"user",content:o}),this.inputMessage="";try{const a=await(await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:o,chat_history:this.messages.slice(-5),mode:this.selectedMode,graphrag:this.graphRagEnabled,report:this.report,selected_api:this.selectedApi,selected_model:this.selectedModel})})).json();let l="";for await(const n of this.mockStream(a.content))l+=n,this.updateAssistantMessage(l)}catch(e){console.error("Error:",e),this.addMessage("assistant","请求处理失败，请重试")}}},updateAssistantMessage(o){const e=this.messages[this.messages.length-1];(e==null?void 0:e.role)==="assistant"?e.content=o:this.messages.push({role:"assistant",content:o}),this.$nextTick(()=>{this.$refs.chatHistory.scrollTop=this.$refs.chatHistory.scrollHeight})},async handleFileUpload(o){const e=Array.from(o.target.files),a=new FormData;e.forEach(l=>a.append("files",l));try{const n=await(await fetch("/api/upload_eval",{method:"POST",body:a})).json();n.status==="success"&&alert(`文件上传成功！知识图谱节点数：${n.total_nodes}, 边数：${n.total_edges}`)}catch(l){console.error("上传异常：",l),alert("文件上传失败，请检查文件格式")}},async load_embedding(){try{(await(await fetch("/api/load_dataset_embedding",{method:"POST"})).json()).status==="success"&&(console.log("知识库加载成功"),alert("专家知识库已加载"))}catch(o){console.error("加载失败：",o),alert("知识库加载失败")}},async generateReport(){try{document.getElementById("generate-btn").style.display="none",document.getElementById("generating-btn").style.display="inline-block";const e=await(await fetch("/api/generate_report",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.authStore.token}`},body:JSON.stringify({video_id:this.currentVideoId})})).json();e.report&&(this.report=e.report,document.getElementById("generating-btn").style.display="none",document.getElementById("download-btn").style.display="inline-block")}catch(o){console.error("生成报告失败：",o),alert("报告生成失败")}},downloadReport(){const o=new Blob([this.report],{type:"text/markdown;charset=utf-8"}),e=document.createElement("a");e.href=URL.createObjectURL(o),e.download="专业分析报告.md",e.click()},async loadReport(){try{const e=await(await fetch("/api/load_report",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.authStore.token}`}})).json();if(e.status==="success")this.report=e.report,document.getElementById("download-btn").style.display="inline-block",alert("报告加载成功");else throw new Error(e.error||"报告加载失败")}catch(o){console.error("加载报告失败:",o),alert(o.message)}},clearHistory(){this.messages=[]},async*mockStream(o){const e=o.split(`
`);for(const a of e)yield new Promise(l=>setTimeout(()=>l(a+`
`),80))}}},C={class:"chat-container"},I={class:"sidebar"},B={class:"bar-section model-section"},V={class:"select-group"},j=["value"],U={class:"bar-section mode-section"},O={class:"select-group"},H=["value"],P={class:"bar-section"},D={class:"select-group"},N={class:"file-upload"},F={class:"report-section"},G={class:"chat-wrapper"},q={class:"chat-history",ref:"chatHistory"},z={class:"input-area"};function L(o,e,a,l,n,r){const y=f("MarkdownRenderer");return d(),i("div",C,[s("aside",I,[s("div",B,[e[14]||(e[14]=s("h4",{class:"section-title"},"模型切换",-1)),s("div",V,[c(s("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>n.selectedApi=t),class:"form-select"},e[13]||(e[13]=[s("option",{value:"qianfan"},"百度千帆",-1),s("option",{value:"openai"},"OpenAI",-1)]),512),[[m,n.selectedApi]]),c(s("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>n.selectedModel=t),class:"form-select"},[(d(!0),i(u,null,h(n.apiModels[n.selectedApi],t=>(d(),i("option",{value:t.value,key:t.value},g(t.text),9,j))),128))],512),[[m,n.selectedModel]])])]),s("div",U,[e[15]||(e[15]=s("h4",{class:"section-title"},"模式选择 RAG",-1)),s("div",O,[(d(!0),i(u,null,h(n.modes,t=>(d(),i("label",{key:t.value},[c(s("input",{type:"radio","onUpdate:modelValue":e[2]||(e[2]=p=>n.selectedMode=p),value:t.value,onChange:e[3]||(e[3]=p=>n.selectedMode==="expert"&&r.load_embedding())},null,40,H),[[v,n.selectedMode]]),s("span",null,g(t.label),1)]))),128))])]),s("div",P,[s("div",D,[s("label",null,[c(s("input",{type:"checkbox","onUpdate:modelValue":e[4]||(e[4]=t=>n.graphRagEnabled=t)},null,512),[[M,n.graphRagEnabled]]),e[16]||(e[16]=s("span",null,"GraphRAG",-1))]),s("label",N,[e[17]||(e[17]=w(" 📁 上传文档 ")),s("input",{type:"file",onChange:e[5]||(e[5]=(...t)=>r.handleFileUpload&&r.handleFileUpload(...t)),multiple:"",hidden:""},null,32)])]),s("div",F,[s("button",{onClick:e[6]||(e[6]=(...t)=>r.generateReport&&r.generateReport(...t)),id:"generate-btn",class:"btn report-btn"}," 生成分析报告 "),s("button",{onClick:e[7]||(e[7]=(...t)=>r.downloadReport&&r.downloadReport(...t)),id:"download-btn",class:"btn report-btn",style:{display:"none"}}," 下载报告 "),e[18]||(e[18]=s("button",{id:"generating-btn",class:"btn report-btn",style:{display:"none"},disabled:""}," 生成中... ",-1))]),s("button",{onClick:e[8]||(e[8]=(...t)=>r.loadReport&&r.loadReport(...t)),class:"btn report-btn"}," 加载分析报告 "),s("button",{onClick:e[9]||(e[9]=(...t)=>r.clearHistory&&r.clearHistory(...t)),class:"btn clear-btn"},"清除历史")])]),s("div",G,[s("div",q,[(d(!0),i(u,null,h(n.messages,(t,p)=>(d(),i("div",{key:p,class:k(["chat-message",t.role])},[R(y,{content:t.content},null,8,["content"])],2))),128))],512),s("div",z,[c(s("input",{"onUpdate:modelValue":e[10]||(e[10]=t=>n.inputMessage=t),onKeyup:e[11]||(e[11]=x((...t)=>r.sendMessage&&r.sendMessage(...t),["enter"])),class:"chat-input",placeholder:"输入你的问题..."},null,544),[[S,n.inputMessage]]),s("button",{onClick:e[12]||(e[12]=(...t)=>r.sendMessage&&r.sendMessage(...t)),class:"btn send-btn"},e[19]||(e[19]=[s("span",{class:"btn-content"},"发送",-1)]))])])])}const Y=A(T,[["render",L],["__scopeId","data-v-ef10659f"]]);export{Y as default};
